# üêõ Base de Connaissances - Bugs & Solutions n8n

**Objectif**: R√©pertorier tous les bugs rencontr√©s dans les workflows n8n pour √©viter de les r√©soudre plusieurs fois.

**Utilisation**: Avant de d√©bugger, TOUJOURS consulter ce fichier avec Grep/Read pour voir si le bug est connu.

---

## üìã Index par Cat√©gorie

- [Nodes n8n](#nodes-n8n)
- [Langchain & Agents](#langchain--agents)
- [MCP Integration](#mcp-integration)
- [Expressions & Variables](#expressions--variables)
- [API & Int√©grations](#api--int√©grations)
- [Performance & M√©moire](#performance--m√©moire)
- [Credentials & Auth](#credentials--auth)

---

## Format de Documentation

Chaque bug suit ce format:

```markdown
### [BUG-XXX] Titre court du bug

**Date**: YYYY-MM-DD
**Cat√©gorie**: [Node/API/Performance/etc.]
**S√©v√©rit√©**: üî¥ Critique | üü° Important | üü¢ Mineur
**Workflow(s) affect√©(s)**: Nom du/des workflow(s)

**üîç Sympt√¥mes**:
- Description du comportement observ√©
- Messages d'erreur

**üéØ Cause racine**:
Explication technique de la cause

**‚úÖ Solution**:
1. √âtapes de r√©solution
2. Code/configuration √† modifier
3. Validation

**üîÑ Pr√©vention**:
- Bonnes pratiques pour √©viter ce bug
- Patterns √† suivre

**üîó R√©f√©rences**:
- Liens documentation n8n
- Discussions forum
- GitHub issues
```

---

## Nodes n8n

### [BUG-001] Placeholder - Premier bug √† documenter

**Date**: 2025-10-31
**Cat√©gorie**: Template
**S√©v√©rit√©**: üü¢ Mineur
**Workflow(s) affect√©(s)**: N/A

**üîç Sympt√¥mes**:
- Ceci est un template d'exemple

**üéØ Cause racine**:
Template pour documentation future

**‚úÖ Solution**:
Remplacer par de vrais bugs rencontr√©s

**üîÑ Pr√©vention**:
Documenter chaque bug d√®s qu'il est r√©solu

**üîó R√©f√©rences**:
- https://docs.n8n.io/

---

## Langchain & Agents

### [BUG-002] Agent hallucine au lieu d'utiliser les tools MCP

**Date**: 2025-10-31
**Cat√©gorie**: Langchain/Agent
**S√©v√©rit√©**: üî¥ Critique
**Workflow(s) affect√©(s)**: Agent Telegram - Dev Ideas

**üîç Sympt√¥mes**:
- L'agent r√©pond "‚úÖ Suppression effectu√©e ! IDEA-XXX a √©t√© supprim√©e" SANS appeler `delete_idea()`
- Il invente des IDs et des confirmations
- L'utilisateur pense que l'action est faite alors qu'elle ne l'est pas
- Aucun tool call n'appara√Æt dans les logs d'ex√©cution

**üéØ Cause racine**:
**Hallucination LLM** : Claude (et tous les LLMs) peuvent r√©pondre directement au lieu d'appeler les tools disponibles, m√™me si le system prompt dit "TOUJOURS utiliser les outils".

Causes techniques :
1. Le system prompt n'est pas assez **explicite et strict**
2. La temp√©rature du LLM (0.7 par d√©faut) permet trop de cr√©ativit√©
3. Claude peut "penser" qu'il aide l'utilisateur en r√©pondant rapidement
4. Pas de validation que les tools DOIVENT √™tre appel√©s

C'est un probl√®me connu avec les agents LangChain.

**‚úÖ Solution**:
1. **System prompt BEAUCOUP plus strict** avec menaces explicites
2. **Checklist de v√©rification** avant chaque r√©ponse
3. **Baisser la temp√©rature** √† 0.2 (plus d√©terministe)
4. **Instructions de fallback** si pas d'outil applicable
5. **(OPTIONNEL)** Utiliser `tool_choice='required'` dans l'API Anthropic

**üîÑ Pr√©vention**:
- **Toujours tester** l'agent apr√®s modification du prompt
- **V√©rifier les logs d'ex√©cution** pour confirmer que les tools sont appel√©s
- **√ätre TR√àS explicite** dans les system prompts
- **Temp√©rature basse** (0.1-0.3) pour agents avec workflows stricts

**üîó R√©f√©rences**:
- [Anthropic - Tool Choice](https://docs.anthropic.com/en/docs/build-with-claude/tool-use)

---

## MCP Integration

### [BUG-003] Tool delete_idea retourne "workflow did not return a response"

**Date**: 2025-10-31
**Cat√©gorie**: MCP/LangChain Tool Workflow
**S√©v√©rit√©**: üî¥ Critique
**Workflow(s) affect√©(s)**: MCP - Id√©e Dev Nico (Perso)

**üîç Sympt√¥mes**:
- Erreur: `The workflow did not return a response`
- Tool `delete_idea` √©choue syst√©matiquement
- Agent LLM re√ßoit "Missing required parameter: operation"
- LangChain schema validation error: "Received tool input did not match expected schema"

**üéØ Cause racine**:
**Param√®tres tool mal configur√©s** : Le tool `delete_idea` avait 6 param√®tres tous marqu√©s comme `required: true`, alors que seul `idea_id` √©tait n√©cessaire pour l'op√©ration.

Causes techniques d√©taill√©es :
1. **Trop de param√®tres requis** : `operation`, `query`, `idea_id`, `title`, `content`, `category` tous required
2. **LLM ne sait pas quoi remplir** : Claude ne peut pas deviner des valeurs pour `operation`, `query`, `title`, etc.
3. **Validation LangChain √©choue** : Input ne correspond pas au schema attendu
4. **Workflow ne s'ex√©cute jamais** : Bloqu√© d√®s la validation d'input
5. **Structure input incorrecte** : Data arrivait dans `{query: {operation, idea_id}}` au lieu de root level
6. **Node cache probl√®me** : Ancien node avec mauvaise config restait en cache malgr√© modifications JSON

**‚úÖ Solution**:

**1. Simplifier le tool √† UN SEUL param√®tre visible** :
```python
params['workflowInputs'] = {
    "mappingMode": "defineBelow",
    "value": {
        "idea_id": "={{ $fromAI('idea_id', '', 'string') }}",
        "__operation__": "delete_idea"  # Cach√©, pour routing interne
    },
    "schema": [
        {
            "id": "idea_id",
            "displayName": "idea_id",
            "required": True,  # SEUL param√®tre requis
            "type": "string",
            "description": "ID de l'id√©e √† archiver (format: IDEA-XXXXXXXX)"
        },
        {
            "id": "__operation__",
            "displayName": "__operation__",
            "required": False,
            "display": False,  # Cach√© √† l'utilisateur
            "type": "string"
        }
    ]
}
```

**2. Adapter le Switch pour lire `__operation__`** :
```python
for rule in rules:
    if rule.get('outputKey') == 'delete_idea':
        rule['conditions']['conditions'][0]['leftValue'] = "={{ $json.__operation__ }}"
        rule['conditions']['conditions'][0]['rightValue'] = "delete_idea"
```

**3. Simplifier le code "Prepare Delete Idea"** :
```javascript
const input = $input.first().json;
const requestedId = (input.idea_id || '').trim();

console.log('[DELETE DEBUG] Input:', JSON.stringify(input));
console.log('[DELETE DEBUG] Requested ID:', requestedId);

if (!requestedId) {
  return [{ json: {
    response: '‚ùå Param√®tre manquant.\n\nUtilisation: delete_idea(idea_id="IDEA-XXXXXXXX")',
    error: true
  } }];
}

const allIdeas = $('Notion - Get Ideas For Delete').all();
const idea = allIdeas.find(item => {
  const id = (item.json.property_id || '').trim();
  return id === requestedId;
});

if (!idea) {
  const errorResponse = `‚ùå Id√©e "${requestedId}" non trouv√©e.\n\nV√©rifie l'ID avec search_ideas().`;
  return [{ json: { response: errorResponse, error: true } }];
}

return [{
  json: {
    id: requestedId,
    notion_page_id: idea.json.id,
    title: idea.json.property_titre_de_l_id_e || 'Sans titre'
  }
}];
```

**4. Forcer nouveau node avec UUID frais** :
```python
# Supprimer compl√®tement l'ancien node
workflow['nodes'] = [n for n in workflow['nodes'] if n['name'] != 'Notion - Get Ideas For Delete']

# Cr√©er nouveau node avec nouveau UUID
new_node_id = str(uuid.uuid4()).replace('-', '')[:24]  # d7752c10dea141d0a2488dc4
new_node = {
    "parameters": search_ideas_node['parameters'].copy(),
    "type": "n8n-nodes-base.notion",
    "typeVersion": 2.2,
    "id": new_node_id,
    "name": "Notion - Get Ideas For Delete"
}
```

**5. D√©ployer avec script Python** :
```bash
python3 scripts/fix-delete-tool-params.py
./scripts/deploy.sh
```

**üîÑ Pr√©vention**:
- **Minimalisme des param√®tres** : Ne demander QUE ce qui est strictement n√©cessaire
- **Regarder les tools qui fonctionnent** : S'inspirer de `create_idea`, `update_idea`, etc.
- **Tester avec l'agent** : V√©rifier que l'agent peut r√©ellement appeler le tool
- **Debug logging** : Ajouter `console.log('[DEBUG] Input:', JSON.stringify(input))` pour voir ce qui arrive
- **Param√®tres cach√©s pour routing** : Utiliser `display: false` pour param√®tres internes
- **Remplacer nodes probl√©matiques** : Si cache persiste, supprimer et recr√©er avec nouveau UUID
- **√âviter Python boolean errors** : Utiliser `True/False` pas `true/false` dans scripts Python

**üîó R√©f√©rences**:
- [LangChain Tool Workflow n8n](https://docs.n8n.io/integrations/builtin/cluster-nodes/root-nodes/n8n-nodes-langchain.toolworkflow/)
- [n8n Expression Resolution](https://docs.n8n.io/code/expressions/)
- Script fix: `scripts/fix-delete-tool-params.py`
- Script deploy: `scripts/deploy.sh`

**üí° Le√ßons apprises**:
1. **KISS principle** : Simplifier au maximum, ne pas sur-ing√©nierer
2. **User feedback crucial** : "Regarde les tools qui fonctionnent" ‚Üí cl√© de la solution
3. **Debugging m√©thodique** : Input structure ‚Üí Routing ‚Üí Execution ‚Üí Response
4. **Ne JAMAIS utiliser boolean lowercase en Python** : `True` pas `true`

---

---

## Expressions & Variables

<!-- Les bugs li√©s aux expressions n8n, $json, $node(), etc. -->

---

## API & Int√©grations

### [BUG-001] delete_idea pr√©tend supprimer mais archive seulement

**Date**: 2025-10-31
**Cat√©gorie**: API/Integration
**S√©v√©rit√©**: üü° Important
**Workflow(s) affect√©(s)**: MCP - Id√©e Dev Nico (Perso)

**üîç Sympt√¥mes**:
- L'outil `delete_idea` retourne un message de succ√®s "supprim√©e avec succ√®s"
- L'id√©e reste visible dans la database Notion
- L'utilisateur pense que la suppression a √©chou√©

**üéØ Cause racine**:
L'API Notion ne permet PAS la suppression d√©finitive de pages. Seulement l'archivage.
Le node Notion utilise l'op√©ration `archive` qui:
- Marque la page comme archiv√©e
- La cache de la vue par d√©faut
- Mais ne la supprime PAS d√©finitivement

C'est une **limitation de l'API Notion**, pas du workflow n8n.

**‚úÖ Solution**:
1. Corriger la description du tool `delete_idea` pour √™tre honn√™te:
   ```
   "Archive une id√©e dans Notion (√©quivalent √† suppression).
   L'id√©e sera archiv√©e et n'appara√Ætra plus dans les recherches.
   Note: L'API Notion ne permet pas la suppression d√©finitive."
   ```

2. Mettre √† jour les notes du node "Notion - Delete Idea":
   ```
   ‚ö†Ô∏è Archive l'id√©e dans Notion

   IMPORTANT: L'API Notion ne permet pas la suppression d√©finitive.
   La page est archiv√©e et n'appara√Æt plus dans les vues.
   ```

3. Corriger les messages de succ√®s pour dire "archiv√©e" au lieu de "supprim√©e"

**üîÑ Pr√©vention**:
- Toujours v√©rifier les limitations de l'API externe avant de promettre des fonctionnalit√©s
- Documenter clairement les limitations dans les descriptions des tools MCP
- √ätre transparent avec l'utilisateur sur ce qui se passe r√©ellement

**üîó R√©f√©rences**:
- [Notion API - Archive page](https://developers.notion.com/reference/archive-a-page)
- Note: Aucun endpoint "delete" n'existe dans l'API Notion

---

## Performance & M√©moire

<!-- Les bugs de performance, timeouts, m√©moire excessive -->

---

## Credentials & Auth

<!-- Les bugs d'authentification, credentials, tokens -->

---

## üìä Statistiques

**Total bugs document√©s**: 3
**Bugs r√©solus**: 3
**Bugs r√©currents**: 0

**Derni√®re mise √† jour**: 2025-10-31

**Par s√©v√©rit√©**:
- üî¥ Critique: 2 (Agent hallucination, delete_idea workflow error)
- üü° Important: 1 (delete_idea API limitation)
- üü¢ Mineur: 0

**Top 3 bugs les plus fr√©quents**:
1. Tool parameters mal configur√©s (BUG-003)
2. Agent hallucination au lieu d'utiliser tools (BUG-002)
3. API limitations non document√©es (BUG-001)

---

## üîç Guide de Recherche Rapide

### Par Sympt√¥me
```bash
# Chercher par message d'erreur
grep -i "error message" BUGS_KNOWLEDGE.md

# Chercher par node
grep -i "Telegram" BUGS_KNOWLEDGE.md

# Chercher par workflow
grep -i "workflow-name" BUGS_KNOWLEDGE.md
```

### Par Cat√©gorie
```bash
# Tous les bugs critiques
grep "üî¥ Critique" BUGS_KNOWLEDGE.md

# Bugs d'un node sp√©cifique
grep -A 20 "## Langchain & Agents" BUGS_KNOWLEDGE.md
```

---

## üéì Patterns de Bugs R√©currents

### Pattern 1: _√Ä identifier_
**Fr√©quence**: _√Ä mesurer_
**Impact**: _√Ä √©valuer_
**Solution g√©n√©rique**: _√Ä documenter_

---

## üìù Changelog

### 2025-10-31
- Cr√©ation de la base de connaissances
- Structure initiale mise en place
